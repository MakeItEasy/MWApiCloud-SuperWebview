<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"/>
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>WinB</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/box.css" />
    <script type="text/javascript" src="../script/public.js"></script>
    <style>
    	p{
    		color:#999;
    		padding:5px;
    	}
    </style>
    <script type="text/javascript">
        var upLoadPicUrl = 'http://192.168.5.12:9001/zysso/wz/patient/uploadPatientPhoto';
        var token = '';
	    apiready = function(){
			fixStatusBar();//沉浸式效果，支持IOS7及Android4.4及以上
            getToken();
			
	    };

        function getToken(){
            api.accessNative({
                        name: 'loadToken',
                        extra: ''
                    }, function(resp){
                        token = resp;
                        loadPhotoUrl();
                });
        }

		function loadPhotoUrl(){
            api.accessNative({
                name: 'getPhotoUrl',
                extra: ''
            }, function(resp){
                document.getElementById("img").src = resp.photoUrl;
                api.toast({ msg: resp.photoUrl });
            });
        }

	    function selectPhoto(){
            api.accessNative({
                name: 'selectPhoto',
                extra: ''
            }, function (callBack) {
                location.reload();
                api.toast({ msg: callBack.photoUrl });
            });
        }

        function getPic(){
            api.confirm({
                title: '请选择',
                msg: '选择路径',
                buttons: ['摄像头', '相册', '取消']
            }, function(ret, err){
                if (ret.buttonIndex == 1) {
                    openCamera();
                }else if (ret.buttonIndex == 2) {
                    openAlbum();
                }else {
                    
                }
            }) 
        }

        function openCamera(){
            api.getPicture({
                sourceType: 'camera',
                encodingType: 'jpg',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: true,
                quality: 50,
                targetWidth: 100,
                targetHeight: 100,
                saveToPhotoAlbum: false
            }, function(ret, err) {
                if (ret) {
                    upLoadPic(ret.data);
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }

        function openAlbum(){
            api.getPicture({
                sourceType: 'album',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: true,
                quality: 50,
                targetWidth: 100,
                targetHeight: 100,
                saveToPhotoAlbum: false
            }, function(ret, err) {
                if (ret) {
                    upLoadPic(ret.data);
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }

        function upLoadPic(path){
            alert(path);
            api.ajax({
                url: upLoadPicUrl,
                headers: {
                        Authorization: token, 
                        APIType: '1'
                },
                cache: false,
                method: 'post',
                timeout: 30,
                dataType: 'json',
                returnAll:false,
                data:{
                    body: {},
                    files: {file: path}
                }
            },function(ret,err){
                if (ret) {
                    api.toast({ msg: '上传成功！' });
                    location.reload();
                }else {
                    api.alert({
                        msg:('错误码：'+err.code+'；错误信息：'+err.msg+'网络状态码：'+err.statusCode)
                    });
                };
            });
        }
	</script>
</head>
<body>
<div id="wrap">
    <div id='header'>
        <div class="back" tapmode="back-active" onclick="api.closeWin()">返回</div>
        <h1>上传头像</h1>
        <div class="adpt" ></div>
        <img src="" class="prevw">
    </div>
    <div class='itemtitle'></div>
    <lable>设置发送给Native的数据</lable><br>
    <input type="text" id="extra" placeholder="请输入任意数据"/>
    <br>
    <br>
    <div class="clickbtn" tapmode="active" onclick="selectPhoto()">选择头像</div>
    <!-- <div class="clickbtn" tapmode="active" onclick="getPic()">选择头像</div> -->
    <br>
    <br>
    <lable>当前头像</lable><br>
    <br>
    <img id="img" src="" alt="图片" width="250" height="250"/>
</div>
</div>
</body>
</html>
